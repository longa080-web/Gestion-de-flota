<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario y Gestión de Flota</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <!-- Reemplazar CDN de Tailwind por una versión estable -->
    <script src="https://cdn.tailwindcss.com/3.3.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script>
    
    <!-- Firebase App (the core Firebase SDK) -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCo5Q10ZQ42pwgGSS-v-yYmcoAxIo8vAoE",
            authDomain: "gestion-de-flota-5a657.firebaseapp.com",
            projectId: "gestion-de-flota-5a657",
            storageBucket: "gestion-de-flota-5a657.firebasestorage.app",
            messagingSenderId: "540590464439",
            appId: "1:540590464439:web:aa0a4d01209709a4821c32"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        
        // Hacer disponible Firebase para el resto de la aplicación
        window.firebaseApp = app;
        console.log('Firebase inicializado correctamente con la nueva configuración');
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .bg-inter-primary { background-color: #005BAA; }
        .bg-inter-accent-light { background-color: #5CE1E6; }
        .bg-inter-accent-yellow { background-color: #FDD000; }
        .text-inter-primary { color: #005BAA; }
        .tab-link.active span { border-bottom-color: #005BAA; color: #005BAA; }
        .tab-link:not(.active) span:hover { color: #005BAA; }
        .tab-link.active svg path { fill: #005BAA; }
        .tab-link:not(.active) svg:hover path { fill: #005BAA; }
    </style>
</head>
<body class="bg-gray-100">

    <!-- El resto del HTML se mantiene exactamente igual -->
    <header class="bg-inter-primary text-white p-4 shadow-md">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold">Gestión de Flota</h1>
        </div>
    </header>

    <main class="container mx-auto p-6">
        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <div class="flex border-b border-gray-200">
                <button class="tab-link active focus:outline-none p-4" data-tab-id="vehiculos">
                    <span class="font-medium text-lg border-b-2 border-transparent pb-4">Registro de Vehículos</span>
                </button>
                <button class="tab-link focus:outline-none p-4" data-tab-id="mantenimientos">
                    <span class="font-medium text-lg border-b-2 border-transparent pb-4">Registro de Mantenimientos</span>
                </button>
                <button class="tab-link focus:outline-none p-4" data-tab-id="inspeccion">
                    <span class="font-medium text-lg border-b-2 border-transparent pb-4">Inspección Pre-Operacional</span>
                </button>
                <button class="tab-link focus:outline-none p-4" data-tab-id="combustible">
                    <span class="font-medium text-lg border-b-2 border-transparent pb-4">Control de Combustible</span>
                </button>
                <button class="tab-link focus:outline-none p-4" data-tab-id="siniestros">
                    <span class="font-medium text-lg border-b-2 border-transparent pb-4">Registro de Siniestros</span>
                </button>
                <button class="tab-link focus:outline-none p-4" data-tab-id="lavado">
                    <span class="font-medium text-lg border-b-2 border-transparent pb-4">Lavado de autos</span>
                </button>
                <button class="tab-link focus:outline-none p-4" data-tab-id="gasoil-head-end">
                    <span class="font-medium text-lg border-b-2 border-transparent pb-4">Gasoil Head End</span>
                </button>
                <button class="tab-link focus:outline-none p-4" data-tab-id="reportes">
                    <span class="font-medium text-lg border-b-2 border-transparent pb-4">Reportes y Estadísticas</span>
                </button>
            </div>

            <div id="tab-content" class="mt-6">

                <!-- Pestaña de Vehículos -->
                <div id="vehiculos" class="tab-pane">
                    <h2 class="text-xl font-semibold text-inter-primary mb-4">Registro de Vehículos</h2>
                    <form id="vehicleForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                        <input type="hidden" id="vehicleId">
                        <div>
                            <label for="placa" class="block text-sm font-medium text-gray-700">Placa</label>
                            <input type="text" id="placa" name="placa" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-inter-primary focus:ring focus:ring-inter-primary focus:ring-opacity-50 p-2" required>
                        </div>
                        <div>
                            <label for="marca" class="block text-sm font-medium text-gray-700">Marca</label>
                            <input type="text" id="marca" name="marca" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-inter-primary focus:ring focus:ring-inter-primary focus:ring-opacity-50 p-2" required>
                        </div>
                        <div>
                            <label for="modelo" class="block text-sm font-medium text-gray-700">Modelo</label>
                            <input type="text" id="modelo" name="modelo" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-inter-primary focus:ring focus:ring-inter-primary focus:ring-opacity-50 p-2" required>
                        </div>
                        <div>
                            <label for="anio" class="block text-sm font-medium text-gray-700">Año</label>
                            <input type="number" id="anio" name="anio" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-inter-primary focus:ring focus:ring-inter-primary focus:ring-opacity-50 p-2" required>
                        </div>
                        <div>
                            <label for="centroOperaciones" class="block text-sm font-medium text-gray-700">Centro de Operaciones</label>
                            <input list="centroOperacionesList" id="centroOperaciones" name="centroOperaciones" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-inter-primary focus:ring focus:ring-inter-primary focus:ring-opacity-50 p-2" required>
                            <datalist id="centroOperacionesList">
                                <option value="MSO">
                                <option value="UN CCS">
                            </datalist>
                        </div>
                        <div>
                            <label for="capacidadTanque" class="block text-sm font-medium text-gray-700">Capacidad Tanque</label>
                            <input type="number" id="capacidadTanque" name="capacidadTanque" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-inter-primary focus:ring focus:ring-inter-primary focus:ring-opacity-50 p-2">
                        </div>
                        <div>
                            <label for="departamentoAsignado" class="block text-sm font-medium text-gray-700">Departamento Asignado</label>
                            <input type="text" id="departamentoAsignado" name="departamentoAsignado" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-inter-primary focus:ring focus:ring-inter-primary focus:ring-opacity-50 p-2">
                        </div>
                        <div>
                            <label for="estado" class="block text-sm font-medium text-gray-700">Estado</label>
                            <input type="text" id="estado" name="estado" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-inter-primary focus:ring focus:ring-inter-primary focus:ring-opacity-50 p-2">
                        </div>
                        <div class="col-span-full">
                            <button type="submit" class="bg-inter-primary text-white font-bold py-2 px-4 rounded-md shadow hover:bg-inter-accent-light hover:text-inter-primary transition duration-300">Guardar Vehículo</button>
                            <button type="button" id="deleteMassiveBtn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-md shadow hover:bg-red-700 transition duration-300">Eliminar Todos los Vehículos</button>
                        </div>
                    </form>

                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center">
                            <input type="file" id="importVehicleFile" accept=".xlsx, .xls, .csv" class="hidden">
                            <button id="importVehicleBtn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-md shadow hover:bg-blue-700 transition duration-300">Importar Vehículos</button>
                        </div>
                        <input type="text" id="searchVehicleInput" placeholder="Buscar vehículo..." class="flex-grow p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-inter-primary ml-4">
                        <button id="exportVehicleBtn" class="ml-4 bg-green-600 text-white font-bold py-2 px-4 rounded-md shadow hover:bg-green-700 transition duration-300">Exportar a Excel</button>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border border-gray-200" id="vehicleTable">
                            <thead>
                                <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                                    <th class="py-3 px-6 text-left">Placa</th>
                                    <th class="py-3 px-6 text-left">Marca</th>
                                    <th class="py-3 px-6 text-left">Modelo</th>
                                    <th class="py-3 px-6 text-left">Año</th>
                                    <th class="py-3 px-6 text-left">Centro de Operaciones</th>
                                    <th class="py-3 px-6 text-left">Capacidad Tanque</th>
                                    <th class="py-3 px-6 text-left">Departamento Asignado</th>
                                    <th class="py-3 px-6 text-left">Estado</th>
                                    <th class="py-3 px-6 text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody class="text-gray-600 text-sm font-light" id="vehicleTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Las demás pestañas se mantienen exactamente igual que en tu código original -->
                <!-- Pestaña de Mantenimientos -->
                <div id="mantenimientos" class="tab-pane hidden">
                    <!-- ... contenido igual ... -->
                </div>

                <!-- Pestaña de Inspección Pre-Operacional -->
                <div id="inspeccion" class="tab-pane hidden">
                    <!-- ... contenido igual ... -->
                </div>

                <!-- Pestaña de Control de Combustible -->
                <div id="combustible" class="tab-pane hidden">
                    <!-- ... contenido igual ... -->
                </div>

                <!-- Pestaña de Siniestros -->
                <div id="siniestros" class="tab-pane hidden">
                    <!-- ... contenido igual ... -->
                </div>

                <!-- Pestaña de Lavado de autos -->
                <div id="lavado" class="tab-pane hidden">
                    <!-- ... contenido igual ... -->
                </div>

                <!-- Pestaña de Gasoil Head End -->
                <div id="gasoil-head-end" class="tab-pane hidden">
                    <!-- ... contenido igual ... -->
                </div>

                <!-- Pestaña de Reportes y Estadísticas -->
                <div id="reportes" class="tab-pane hidden">
                    <!-- ... contenido igual ... -->
                </div>

            </div>
        </div>
    </main>

    <script>
        // Variables globales para todas las pestañas
        let vehicles = JSON.parse(localStorage.getItem('vehicles')) || [];
        let maintenances = JSON.parse(localStorage.getItem('maintenances')) || [];
        let inspections = JSON.parse(localStorage.getItem('inspections')) || [];
        let fuelRecords = JSON.parse(localStorage.getItem('fuelRecords')) || [];
        let siniestros = JSON.parse(localStorage.getItem('siniestros')) || [];
        let lavados = JSON.parse(localStorage.getItem('lavados')) || [];
        let gasoilRecords = JSON.parse(localStorage.getItem('gasoilRecords')) || [];

        // Variables para los gráficos
        let monthlyComparisonChart = null;
        let expenseDistributionChart = null;

        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            initializeTabs();
            loadAllData();
            setupEventListeners();
            setupImportButtons();
            setupYearSelector();
            updateReports();
        });

        // Nueva función para configurar el selector de año dinámico
        function setupYearSelector() {
            const yearSelect = document.getElementById('reportYear');
            if (!yearSelect) return;
            
            const currentYear = new Date().getFullYear();
            yearSelect.innerHTML = '';
            
            // Agregar años desde 2022 hasta el año actual
            for (let year = 2022; year <= currentYear; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                // Seleccionar el año actual por defecto
                if (year === currentYear) {
                    option.selected = true;
                }
                yearSelect.appendChild(option);
            }
        }

        // Funciones de navegación por pestañas
        function initializeTabs() {
            const tabLinks = document.querySelectorAll('.tab-link');
            tabLinks.forEach(link => {
                link.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab-id');
                    switchTab(tabId);
                });
            });
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.add('hidden');
            });
            document.querySelectorAll('.tab-link').forEach(link => {
                link.classList.remove('active');
            });
            document.getElementById(tabId).classList.remove('hidden');
            document.querySelector(`[data-tab-id="${tabId}"]`).classList.add('active');
            
            if (tabId === 'reportes') {
                setupYearSelector();
                updateReports();
            }
        }

        // Cargar todos los datos
        function loadAllData() {
            loadVehicleData();
            loadMaintenanceData();
            loadInspectionData();
            loadFuelData();
            loadSiniestroData();
            loadLavadoData();
            loadGasoilData();
        }

        // Funciones para Vehículos
        function loadVehicleData() {
            const tbody = document.getElementById('vehicleTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            vehicles.forEach((vehicle, index) => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 hover:bg-gray-100';
                row.innerHTML = `
                    <td class="py-3 px-6 text-left whitespace-nowrap">${vehicle.placa}</td>
                    <td class="py-3 px-6 text-left">${vehicle.marca}</td>
                    <td class="py-3 px-6 text-left">${vehicle.modelo}</td>
                    <td class="py-3 px-6 text-left">${vehicle.anio}</td>
                    <td class="py-3 px-6 text-left">${vehicle.centroOperaciones}</td>
                    <td class="py-3 px-6 text-left">${vehicle.capacidadTanque || 'N/A'}</td>
                    <td class="py-3 px-6 text-left">${vehicle.departamentoAsignado || 'N/A'}</td>
                    <td class="py-3 px-6 text-left">${vehicle.estado || 'N/A'}</td>
                    <td class="py-3 px-6 text-center">
                        <button onclick="editVehicle(${index})" class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 transition duration-300">Editar</button>
                        <button onclick="deleteVehicle(${index})" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition duration-300 ml-2">Eliminar</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            updatePlacasList();
        }

        // ... (Todas las demás funciones de carga de datos se mantienen igual) ...

        // FUNCIONES DE EDICIÓN Y ELIMINACIÓN PARA TODAS LAS PESTAÑAS

        // Vehículos
        window.editVehicle = function(index) {
            const vehicle = vehicles[index];
            document.getElementById('vehicleId').value = index;
            document.getElementById('placa').value = vehicle.placa;
            document.getElementById('marca').value = vehicle.marca;
            document.getElementById('modelo').value = vehicle.modelo;
            document.getElementById('anio').value = vehicle.anio;
            document.getElementById('centroOperaciones').value = vehicle.centroOperaciones;
            document.getElementById('capacidadTanque').value = vehicle.capacidadTanque || '';
            document.getElementById('departamentoAsignado').value = vehicle.departamentoAsignado || '';
            document.getElementById('estado').value = vehicle.estado || '';
        };

        window.deleteVehicle = function(index) {
            if (confirm('¿Está seguro de que desea eliminar este vehículo?')) {
                vehicles.splice(index, 1);
                localStorage.setItem('vehicles', JSON.stringify(vehicles));
                loadVehicleData();
                updateReports();
            }
        };

        // ... (Todas las demás funciones de edición y eliminación se mantienen igual) ...

        // FUNCIONES CORREGIDAS PARA LOS GRÁFICOS

        function updateMonthlyComparisonChart(year) {
            const ctx = document.getElementById('monthlyComparisonChart');
            if (!ctx) return;
            
            const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
            const msoData = [];
            const unccsData = [];
            
            for (let month = 1; month <= 12; month++) {
                msoData.push(calculateTotalExpenses('MSO', year, month));
                unccsData.push(calculateTotalExpenses('UN CCS', year, month));
            }
            
            // CORRECCIÓN: Verificar si el gráfico existe antes de destruirlo
            if (monthlyComparisonChart) {
                monthlyComparisonChart.destroy();
            }
            
            monthlyComparisonChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'MSO',
                            data: msoData,
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            tension: 0.1
                        },
                        {
                            label: 'UN CCS',
                            data: unccsData,
                            borderColor: 'rgb(54, 162, 235)',
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: `Comparativa Mensual ${year}`
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateExpenseDistributionChart(year, center = 'all') {
            const ctx = document.getElementById('expenseDistributionChart');
            if (!ctx) return;
            
            const categories = ['Mantenimientos', 'Combustible', 'Siniestros', 'Lavados', 'Gasoil'];
            let data = [];
            
            if (center === 'all') {
                // Combinar ambos centros
                data = [
                    calculateCategoryExpenses('maintenances', year, 'all'),
                    calculateCategoryExpenses('fuel', year, 'all'),
                    calculateCategoryExpenses('siniestros', year, 'all'),
                    calculateCategoryExpenses('lavados', year, 'all'),
                    calculateCategoryExpenses('gasoil', year, 'all')
                ];
            } else {
                // Centro específico
                data = [
                    calculateCategoryExpenses('maintenances', year, center),
                    calculateCategoryExpenses('fuel', year, center),
                    calculateCategoryExpenses('siniestros', year, center),
                    calculateCategoryExpenses('lavados', year, center),
                    calculateCategoryExpenses('gasoil', year, center)
                ];
            }
            
            // CORRECCIÓN: Verificar si el gráfico existe antes de destruirlo
            if (expenseDistributionChart) {
                expenseDistributionChart.destroy();
            }
            
            expenseDistributionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: categories,
                    datasets: [{
                        label: 'Gastos por Categoría',
                        data: data,
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.6)',
                            'rgba(54, 162, 235, 0.6)',
                            'rgba(255, 206, 86, 0.6)',
                            'rgba(75, 192, 192, 0.6)',
                            'rgba(153, 102, 255, 0.6)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: `Distribución de Gastos ${year}`
                        }
                    }
                }
            });
        }

        // ... (El resto de las funciones se mantienen igual) ...

        // Funciones para Reportes
        function updateReports() {
            const year = document.getElementById('reportYear')?.value || new Date().getFullYear();
            const month = document.getElementById('reportMonth')?.value || 'all';
            const center = document.getElementById('reportCenter')?.value || 'all';
            
            updateSummaryCards(year, month, center);
            updateMonthlyComparisonChart(year);
            updateExpenseDistributionChart(year, center);
            updateMonthlyVehicleTables(year);
            updateFuelConsumptionTables(year);
            updateAnnualComparison(year);
            updateOriginalCounters();
        }

        function updateSummaryCards(year, month, center) {
            const msoTotal = calculateTotalExpenses('MSO', year, month);
            const unccsTotal = calculateTotalExpenses('UN CCS', year, month);
            
            const totalMSOElem = document.getElementById('totalMSO');
            const totalUNCCSSElem = document.getElementById('totalUNCCS');
            
            if (totalMSOElem) totalMSOElem.textContent = `$${msoTotal.toFixed(2)}`;
            if (totalUNCCSSElem) totalUNCCSSElem.textContent = `$${unccsTotal.toFixed(2)}`;
            
            // Determinar mayor y menor gasto
            const highestSpenderElem = document.getElementById('highestSpender');
            const highestAmountElem = document.getElementById('highestAmount');
            const lowestSpenderElem = document.getElementById('lowestSpender');
            const lowestAmountElem = document.getElementById('lowestAmount');
            
            if (highestSpenderElem && highestAmountElem && lowestSpenderElem && lowestAmountElem) {
                if (msoTotal > unccsTotal) {
                    highestSpenderElem.textContent = 'MSO';
                    highestAmountElem.textContent = `$${msoTotal.toFixed(2)}`;
                    lowestSpenderElem.textContent = 'UN CCS';
                    lowestAmountElem.textContent = `$${unccsTotal.toFixed(2)}`;
                } else {
                    highestSpenderElem.textContent = 'UN CCS';
                    highestAmountElem.textContent = `$${unccsTotal.toFixed(2)}`;
                    lowestSpenderElem.textContent = 'MSO';
                    lowestAmountElem.textContent = `$${msoTotal.toFixed(2)}`;
                }
            }
            
            // Tendencias (comparación con año anterior)
            const prevYearMSO = calculateTotalExpenses('MSO', parseInt(year)-1, month);
            const prevYearUNCCS = calculateTotalExpenses('UN CCS', parseInt(year)-1, month);
            
            const msoTrend = msoTotal - prevYearMSO;
            const unccsTrend = unccsTotal - prevYearUNCCS;
            
            const msoTrendElem = document.getElementById('msoTrend');
            const unccsTrendElem = document.getElementById('unccsTrend');
            
            if (msoTrendElem) {
                msoTrendElem.textContent = 
                    msoTrend >= 0 ? `+$${msoTrend.toFixed(2)} vs año anterior` : `-$${Math.abs(msoTrend).toFixed(2)} vs año anterior`;
                msoTrendElem.className = `text-sm mt-1 ${msoTrend >= 0 ? 'text-red-600' : 'text-green-600'}`;
            }
            
            if (unccsTrendElem) {
                unccsTrendElem.textContent = 
                    unccsTrend >= 0 ? `+$${unccsTrend.toFixed(2)} vs año anterior` : `-$${Math.abs(unccsTrend).toFixed(2)} vs año anterior`;
                unccsTrendElem.className = `text-sm mt-1 ${unccsTrend >= 0 ? 'text-red-600' : 'text-green-600'}`;
            }
        }

        function calculateTotalExpenses(center, year, month = 'all') {
            let total = 0;
            
            // Mantenimientos
            total += maintenances
                .filter(m => m.centro === center && 
                    (month === 'all' || new Date(m.fecha).getMonth() + 1 == month) &&
                    new Date(m.fecha).getFullYear() == year)
                .reduce((sum, m) => sum + parseFloat(m.costo || 0), 0);
            
            // Combustible
            total += fuelRecords
                .filter(f => f.centro === center && 
                    (month === 'all' || new Date(f.fecha).getMonth() + 1 == month) &&
                    new Date(f.fecha).getFullYear() == year)
                .reduce((sum, f) => sum + parseFloat(f.costo || 0), 0);
            
            // Siniestros
            total += siniestros
                .filter(s => s.centro === center && 
                    (month === 'all' || new Date(s.fechaHora).getMonth() + 1 == month) &&
                    new Date(s.fechaHora).getFullYear() == year)
                .reduce((sum, s) => sum + parseFloat(s.costoReparacion || 0), 0);
            
            // Lavados
            total += lavados
                .filter(l => l.centro === center && 
                    (month === 'all' || new Date(l.fecha).getMonth() + 1 == month) &&
                    new Date(l.fecha).getFullYear() == year)
                .reduce((sum, l) => sum + parseFloat(l.costo || 0), 0);
            
            // Gasoil
            total += gasoilRecords
                .filter(g => g.centro === center && 
                    (month === 'all' || new Date(g.fecha).getMonth() + 1 == month) &&
                    new Date(g.fecha).getFullYear() == year)
                .reduce((sum, g) => sum + parseFloat(g.costo || 0), 0);
            
            return total;
        }

        // ... (El resto del código JavaScript se mantiene igual) ...

        // Configuración de event listeners para formularios
        function setupEventListeners() {
            setupVehicleForm();
            setupMaintenanceForm();
            setupInspectionForm();
            setupFuelForm();
            setupSiniestroForm();
            setupLavadoForm();
            setupGasoilForm();
            setupSearchFunctionality();
            setupReportEventListeners();
            setupExportButtons();
        }

        function setupVehicleForm() {
            const form = document.getElementById('vehicleForm');
            if (form) {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const id = document.getElementById('vehicleId').value;
                    const vehicle = {
                        placa: document.getElementById('placa').value,
                        marca: document.getElementById('marca').value,
                        modelo: document.getElementById('modelo').value,
                        anio: document.getElementById('anio').value,
                        centroOperaciones: document.getElementById('centroOperaciones').value,
                        capacidadTanque: document.getElementById('capacidadTanque').value,
                        departamentoAsignado: document.getElementById('departamentoAsignado').value,
                        estado: document.getElementById('estado').value
                    };

                    if (id === '') {
                        vehicles.push(vehicle);
                    } else {
                        vehicles[id] = vehicle;
                    }

                    localStorage.setItem('vehicles', JSON.stringify(vehicles));
                    loadVehicleData();
                    this.reset();
                    document.getElementById('vehicleId').value = '';
                    updateReports();
                });
            }

            // Botón eliminar todos los vehículos
            const deleteBtn = document.getElementById('deleteMassiveBtn');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', function() {
                    if (confirm('¿Está seguro de que desea eliminar TODOS los vehículos? Esta acción no se puede deshacer.')) {
                        vehicles = [];
                        localStorage.setItem('vehicles', JSON.stringify(vehicles));
                        loadVehicleData();
                        updateReports();
                    }
                });
            }
        }

        // ... (El resto de las funciones de configuración se mantienen igual) ...

    </script>
</body>
</html>
